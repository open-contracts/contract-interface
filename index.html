<h1>Open Contracts Dapp </h1>
<div>
<a href="https://github.com/open-contracts/open-contracts.github.io"> (website source code)</a>
</div>
<br />

<script charset="utf-8" src="https://cdn.jsdelivr.net/npm/@metamask/detect-provider@1.2.0/dist/detect-provider.min.js" type="text/javascript"> </script>
<script charset="utf-8" src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.4.6/ethers.umd.min.js" type="text/javascript"> </script>
<script charset="utf-8" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" type="text/javascript"> </script>

<script charset="utf-8" src="attestation/cbor.js" type="text/javascript"></script>
<script charset="utf-8" src="attestation/cose.js" type="text/javascript"> </script>
<script charset="utf-8" src="attestation/x509.js" type="text/javascript"> </script>
<script charset="utf-8" src="attestation/base64.js" type="text/javascript"> </script>
<script charset="utf-8" src="main.js" type="text/javascript"> </script>

<p>
For now, testnet only.
Make sure you have Metamask installed and are connected to the Ropsten testnet. Also make sure you have some Ropsten Test Ether in your account to pay for Gas fees.
</p>

<div>
<form id="OpenContractForm" action="javascript:void(0);">
	<label for="network"><b>Metamask connected to: </b></label><em id="network"> awaiting connection...</em>
	<br />
	<label for="contractGithub"><b>Contract Address:</b></label>
	<input id="contractGithub" type="text" value="open-contracts/sample-contract" size="60" />
	<br />
	<input type="submit" value="Load Contract" onclick="loadOpenContract()" />
</form>
</div>

<div>
<form id="ContractForm" action="javascript:void(0);">
	<label for="network"><b>Metamask connected to: </b></label><em id="network"> awaiting connection...</em>
	<br />
	<label for="contractAddress"><b>Contract Address:</b></label>
	<input id="contractAddress" type="text" value="0x8d7B945C7e0B412AAD8CBB8D301aD0f7F3f38cC3" size="60" />
	<br />
	<label for="contractABI"><b>Contract ABI:</b></label><br>
	<textarea id="contractABI"  rows="10" cols="80">
[{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"abatementCost","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"abatementShares","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balances","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"abatement","type":"uint256"}],"name":"commit","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"commitment","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"isParticipant","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"participants","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"socialCost","type":"uint256"}],"name":"participate","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"reimburse","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"government","type":"address"},{"internalType":"uint256","name":"abatementShare","type":"uint256"}],"name":"reportAbatement","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"sattelite","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"socialCosts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"sufficientBalance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}]
	</textarea>	
	<br />
	<input type="submit" value="Load Contract" onclick="loadContract()" />
</form>
</div>
<br />
<div id="functionNames"></div>
<br />
<div id="currentFunction"></div>
<div id="results"></div>
<hr><hr>
<p>
This section interacts with the API exposed by the server.py running inside the  <a href="https://github.com/open-contracts/default-image">oracle_enclave</a>.
For now, users can submit and launch arbitrary oracle.py code, and receive output printed by the enclave.
Soon, this client code will 
	1) verify the attestation document to make sure it actually interacts with the right enclave 
	2) match with an enclave provider by automatically interacting with the (yet nonexistent) market contract
</p>
<form id="submitAndRunOracle" action="javascript:void(0);">
	<label for="enclaveProviderIP"><b>Enclave Provider IP:</b></label>
	<input id="enclaveProviderIP" type="text" value="127.0.0.1" size="60" />
	<script type="text/javascript">document.getElementById("enclaveProviderIP").value = new URLSearchParams(window.location.search).get("enclaveProviderIP")</script>
	<br />
	<label for="oracleBundle"><b>Oracle Bundle:</b></label>
    <input id="oracleBundle" type="text" value="https://raw.githubusercontent.com/open-contracts/sample-contract/main/bundle/oracle_bundle.zip" size="60" /><br>
	<input type="submit" value="Submit" onclick="connectEnclave()">
</form>
<u>Enclave Output:</u><br>
<hr>
<div id="enclaveOutput"></div>
<hr>
<div id="xpra"></div>
